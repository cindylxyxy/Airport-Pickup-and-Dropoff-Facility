This is the updated code for implementing the trajectory-based simulation.
